/*! QNickSvgAutoFit.JS - v1.0.2 - 2017-03-30
 * http://nickspace.cn/
 *
 * Copyright (c) 2017 Nick Quan;
 * Licensed under the MIT license */
!function(a,b,c,d,e){function k(b,c,d){this.element=b,this.options=a.extend({},h,c),this._defaults=h,this._status=a.extend({},j,d),this._name=f,this._svg=null,this.init(),a(this.element).trigger("onLoad",this)}var f="QNickSvgAutoFit",g=["customScale","scaleMap","autoScale","autoFit"],h={maxScale:3,minScale:.6,mapData:{},shapesColor:"#FF4239",strokeColor:"#fff",shapesColorOn:"#FF4239",strokeColorOn:"#fff",FontColorOn:"#fff",lightFontColor:"#fff",darkFontColor:"#6f3838",scaleDuration:500,debugMode:!1,selectClassName:"sheng",selectShapeClassName:"shengShape",selectTextClassName:"shengText",scalePadding:30,fitPadding:10},j={mapScale:1,centerX:"center",centerY:"center",moveX:"center",moveY:"center",target:null,eventLock:!0};k.prototype={init:function(){var b=this.element;thisObj=this,this._svg=d(b),this._map=this._svg.paper.g(),this.setMap(),a(c).on("touchstart",function(a){thisObj._status.touchstart||(thisObj.docTouchstart=a,thisObj._status.eventLock=!0)}),a(c).on("mousedown",function(a){thisObj._status.mousedown||(thisObj.docMousedown=a,thisObj._status.eventLock=!0)}),this._svg.mousedown(function(a){if("MouseEvent"==thisObj.getEventTypeName(a)){var b=thisObj._status.docMousedown;b?b.layerX!=e&&b.layerX==a.layerX&&b.layerY==a.layerY&&(thisObj._status.eventLock=!1):thisObj._status.eventLock=!1,thisObj._status.mousedown=a}}),this._svg.mouseup(function(a){if(thisObj._status.eventLock)console.log("EventLocked");else if("MouseEvent"==thisObj.getEventTypeName(a)){var b=thisObj._status.mousedown;thisObj.clickEvent(b,a)}}),this._svg.touchstart(function(a){if("TouchEvent"==thisObj.getEventTypeName(a)){var b=thisObj._status.docTouchstart;b?b.layerX!=e&&b.layerX==a.layerX&&b.layerY==a.layerY&&(thisObj._status.eventLock=!1):thisObj._status.eventLock=!1,thisObj._status.touchstart=a}}),this._svg.touchend(function(a){if(thisObj._status.eventLock)console.log("EventLocked");else if("TouchEvent"==thisObj.getEventTypeName(a)){var b=thisObj._status.touchstart;thisObj.clickEvent(b,a)}}),"function"==typeof this.options.onLoad&&this.options.onLoad(this),this.debug()},clickEvent:function(a,b){var c=this;if(a.layerX!=e){var d=b.layerX-a.layerX,f=b.layerY-a.layerY;if(0==f){this._status.clickX=b.layerX,this._status.clickY=b.layerY;var g=c.fillterTarget(b);g&&c.onClick(g,b.layerX,b.layerY)}else c.onDragend(d,f)}},fillterTarget:function(b){var c=this.options,d=b.path;if(d!=e){for(i=0;i<d.length;i++)if(a(d[i]).attr("class")==c.selectClassName)return d[i];return e}d=b.target;var f=a(d).parents("g."+c.selectClassName);if(f[0]!=e)return f[0]},setMap:function(){var b=this.options.mapData,c=this.options,e=this._svg,f=this._map,g=this,h=e.paper.g().attr({class:"country"});b.shapes&&b.counts&&b.names&&a.each(b.shapes,function(d,f){var i=b.counts[d]/100;!i||i<.05?i=.05:i>1&&(i=1),fillColor=g.opacityColor(c.shapesColor,i);var j=e.paper.g().attr({class:c.selectClassName,name:d}),k=j.add(e.paper.path(f).attr({fill:fillColor,stroke:c.strokeColor,strokeWidth:1.2,class:c.selectShapeClassName}));info=k.getBBox(),info.name=b.names[d],i>.3?fontColor=c.lightFontColor:fontColor=c.darkFontColor,t=e.text(info.name[0],info.name[1],info.name[2]).attr(a.extend({},{fill:fontColor,class:c.selectTextClassName},info.name[3])),j.add(t),h.add(j)});var i=h.getBBox(),j=e.paper.rect(-i.width,-i.height,3*i.width,3*i.height);j.attr({opacity:0,class:"background"}),this.setPositionStatus(i);var k=new d.Matrix,l=this._status;f.add(j),f.add(h),k.add(1,0,0,1,l.moveX,l.moveY),k.scale(l.mapScale,l.mapScale,l.centerX,l.centerY),f.transform(k),f.drag()},setPositionStatus:function(b){var c=this._status,d=this.element;if("string"==typeof c.moveX)switch(c.moveX){case"center":c.moveX=this.numRound((a(d).width()-b.width)/2);break;case"right":c.moveX=this.numRound(a(d).width()-b.width);break;default:c.moveX=0}if("string"==typeof c.moveY)switch(c.moveY){case"center":c.moveY=this.numRound((a(d).height()-b.height)/2);break;case"bottom":c.moveY=this.numRound(a(d).height()-b.height);break;default:c.moveY=0}if("string"==typeof c.centerX)switch(c.centerX){case"center":c.centerX=this.numRound(b.width/2);break;case"right":c.centerX=this.numRound(b.width);break;default:c.centerX=0}if("string"==typeof c.centerY)switch(c.centerY){case"center":c.centerY=this.numRound(b.height/2);break;case"bottom":c.centerY=this.numRound(b.height);break;default:c.centerY=0}this._status=c},customScale:function(a,b,c,d){this._status.moveX=this.numRound(c.x,3),this._status.moveY=this.numRound(c.y,3),this._status.centerX=this.numRound(b.x,3),this._status.centerY=this.numRound(b.y,3),this.scaleMap(a,d),this.debug()},autoScale:function(b,c){var d=this.options,e=this.element;"string"==typeof b&&(b=a(e).find("g."+d.selectClassName+"[name='"+b+"']")[0]),this.setTarget(b);var f={width:a(this.element).width(),height:a(this.element).height()},g=b.getBBox(),h={x:g.x+g.width/2,y:g.y+g.height/2},i={x:f.width/2-h.x,y:f.height/2-h.y},j=f.width-2*d.scalePadding,k=f.height-2*d.scalePadding,l=this.numRound(j/g.width),m=this.numRound(k/g.height),n=l>m?m:l;n=this.numRound(n>d.maxScale?d.maxScale:n),n=this.numRound(n>d.minScale?n:d.minScale),this.customScale(n,h,i,c)},autoFit:function(b){var c=this.options,d=this.element,e=a(d).find("g.country")[0],f={width:a(this.element).width(),height:a(this.element).height()},g=e.getBBox(),h={x:g.x+g.width/2,y:g.y+g.height/2},i={x:f.width/2-h.x,y:f.height/2-h.y},j=f.width-2*c.fitPadding,k=f.height-2*c.fitPadding,l=this.numRound(j/g.width),m=this.numRound(k/g.height),n=l>m?m:l;n=this.numRound(n>c.maxScale?c.maxScale:n),n=this.numRound(n>c.minScale?n:c.minScale),this.customScale(n,h,i,b)},scaleMap:function(a,b){var c=this._status,e=this.options;a/c.mapScale;c.mapScale=a;var g=new d.Matrix;g.add(1,0,0,1,c.moveX,c.moveY);var h=e.scaleDuration;g.scale(c.mapScale,c.mapScale,c.centerX,c.centerY),this._map.animate({transform:g},h,mina.easeinout),this.debug()},moveMap:function(a,b){this._status;this._status.moveX=this._status.moveX+this.numRound(a,3),this._status.moveY=this._status.moveY+this.numRound(b,3),this.scaleMap(this._status.mapScale),this.setCenter(),this.debug()},onDragend:function(a,b){this.moveMap(a,b)},onClick:function(b,c,d){var e={x:c,y:d},f=this.options;this.setScaleCenterPoint(e),this.debug({fill:"#00bd00",stroke:"#6aff2c"}),this.autoScale(b),"function"==typeof f.onClick&&f.onClick(b),a(this.element).trigger("onClick",b),this.debug()},setTarget:function(b){var c=this.options,d=this._status;a(d.target).find("."+c.selectShapeClassName).css({fill:""}),a(d.target).find("."+c.selectTextClassName).css({fill:""}),a(b).find("."+c.selectShapeClassName).css({fill:"#FFCF5B"}),a(b).find("."+c.selectTextClassName).css({fill:"#6f3838"}),this._status.target=b},setScaleCenterPoint:function(a){var b=this._status,c={},d={},e={};d.x=b.moveX,d.y=b.moveY,c.x=this.numRound(b.centerX+(a.x-b.centerX)/b.mapScale-b.moveX/b.mapScale),c.y=this.numRound(b.centerY+(a.y-b.centerY)/b.mapScale-b.moveY/b.mapScale),e.x=a.x-c.x-b.moveX,e.y=a.y-c.y-b.moveY,this._status.moveX=this.numRound(b.moveX+e.x),this._status.moveY=this.numRound(b.moveY+e.y),this._status.centerX=this.numRound(c.x,3),this._status.centerY=this.numRound(c.y,3)},setCenter:function(){var b=this.element,c={x:a(b).width()/2,y:a(b).height()/2};this.setScaleCenterPoint(c)},getEventTypeName:function(a){return Object.prototype.toString.call(a).slice(8,-1)},opacityColor:function(a,b){b=1-b;var c=parseInt(a.slice(1),16),d=b<0?0:255,e=b<0?b*-1:b,f=c>>16,g=c>>8&255,h=255&c;return"#"+(16777216+65536*(Math.round((d-f)*e)+f)+256*(Math.round((d-g)*e)+g)+(Math.round((d-h)*e)+h)).toString(16).slice(1)},numRound:function(a,b){b==e&&(b=3);var c=Math.pow(10,b);return Math.round(a*c)/c},debug:function(b){var c=this.options,d=this._svg,e=this._status,g=this._map,h={fill:"#f00",stroke:"#ff0"},b=a.extend({},h,b);if(c.debugMode){var i=d.paper.circle(e.centerX,e.centerY,2).attr({fill:b.fill,stroke:b.stroke,strokeWidth:1,opacity:.5});g.add(i);var j="";if(a.each(e,function(b,c){if("mousedown"!=b&&"touchstart"!=b)if("target"==b){var d=a(c).attr("name")?"[object]"+a(c).attr("name"):c;j+="<p>"+b+":"+d+"</p>"}else j+="<p>"+b+":"+c+"</p>"}),0==a("#"+f+"_debug").length){var k=this.appendDebugTag();a("body").append(k)}a("#"+f+"_debug").html(j)}},appendDebugTag:function(){var a="";return a+='<div id="'+f+'_debug" style="position: absolute;top: 0;right: 0;padding: 20px;background: rgba(255,255,255,0.7);line-height: 5px;">',a+="</div>"}},a.fn[f]=function(b,c){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new k(this,b,c))})},a(g).each(function(b,c){a.fn[c]=function(b,d,e,g,h,i,j,k,l,m){this.each(function(){a.data(this,"plugin_"+f)&&(thisObj=a.data(this,"plugin_"+f),"function"==typeof thisObj[c]?thisObj[c](b,d,e,g,h,i,j,k,l,m):console.error(f+": ["+c+"] method not defined!"))})}})}(jQuery,window,document,Snap);